import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from 'firebase/firestore';

// Global variables provided by the Canvas environment
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

function App() {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [userName, setUserName] = useState('');
  const [messageText, setMessageText] = useState('');
  const [messages, setMessages] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);

  const messagesEndRef = useRef(null); // Ref for scrolling to the latest message

  // Initialize Firebase and handle authentication
  useEffect(() => {
    const initFirebase = async () => {
      try {
        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);
        const firebaseAuth = getAuth(app);

        setDb(firestore);
        setAuth(firebaseAuth);

        // Listen for auth state changes
        const unsubscribeAuth = onAuthStateChanged(firebaseAuth, async (user) => {
          if (user) {
            setUserId(user.uid);
          } else {
            // If no user, try to sign in anonymously
            try {
              if (initialAuthToken) {
                await signInWithCustomToken(firebaseAuth, initialAuthToken);
              } else {
                await signInAnonymously(firebaseAuth);
              }
            } catch (authError) {
              console.error("Error during authentication:", authError);
              setError("Failed to authenticate. Please try again.");
            }
          }
          setIsLoading(false); // Authentication check is complete
        });

        return () => unsubscribeAuth(); // Cleanup auth listener
      } catch (err) {
        console.error("Failed to initialize Firebase:", err);
        setError("Failed to initialize chat services. Please check your configuration.");
        setIsLoading(false);
      }
    };

    initFirebase();
  }, []); // Run once on component mount

  // Fetch messages in real-time once Firebase and auth are ready
  useEffect(() => {
    if (db && auth && userId) {
      setError(null); // Clear any previous errors

      // Define the collection path for public data
      const chatCollectionRef = collection(db, `artifacts/${appId}/public/data/chatMessages`);
      // Create a query to order messages by timestamp
      const q = query(chatCollectionRef, orderBy('timestamp', 'asc'));

      const unsubscribe = onSnapshot(q, (snapshot) => {
        const fetchedMessages = [];
        snapshot.forEach((doc) => {
          fetchedMessages.push({ id: doc.id, ...doc.data() });
        });
        setMessages(fetchedMessages);
        scrollToBottom(); // Scroll to the latest message
      }, (err) => {
        console.error("Error fetching messages:", err);
        setError("Failed to load messages. Please try refreshing.");
      });

      return () => unsubscribe(); // Cleanup snapshot listener
    }
  }, [db, auth, userId]); // Re-run when db, auth, or userId changes

  // Scroll to the bottom of the chat window
  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  // Handle sending a message
  const handleSendMessage = async () => {
    if (!userName.trim()) {
      alert('Please enter your name before sending a message.'); // Using alert as per instructions, but typically a modal is better
      return;
    }
    if (messageText.trim() === '') {
      alert('Message cannot be empty.'); // Using alert as per instructions
      return;
    }
    if (!db || !userId) {
      setError("Chat service not ready. Please wait or refresh.");
      return;
    }

    try {
      const chatCollectionRef = collection(db, `artifacts/${appId}/public/data/chatMessages`);
      await addDoc(chatCollectionRef, {
        userId: userId,
        userName: userName.trim(),
        messageText: messageText.trim(),
        timestamp: serverTimestamp(), // Use server timestamp for consistent ordering
      });
      setMessageText(''); // Clear input after sending
    } catch (e) {
      console.error("Error adding document: ", e);
      setError("Failed to send message. Please try again.");
    }
  };

  // Handle name change
  const handleNameChange = (e) => {
    setUserName(e.target.value);
  };

  // Handle message input change
  const handleMessageChange = (e) => {
    setMessageText(e.target.value);
  };

  // Handle Enter key press for sending message
  const handleKeyPress = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { // Allow Shift+Enter for new line in textarea
      e.preventDefault(); // Prevent default new line
      handleSendMessage();
    }
  };

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100">
        <div className="text-xl text-gray-700">Loading chat...</div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-red-100 text-red-700 p-4 rounded-lg">
        Error: {error}
      </div>
    );
  }

  return (
    <div className="flex flex-col h-screen bg-gray-100 p-4 font-sans antialiased">
      <div className="flex-grow flex flex-col max-w-2xl mx-auto w-full bg-white rounded-lg shadow-lg overflow-hidden">
        {/* Header */}
        <div className="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-4 text-center text-2xl font-bold rounded-t-lg">
          Global Chat
        </div>

        {/* User ID Display */}
        {userId && (
          <div className="bg-blue-100 text-blue-800 text-sm p-2 text-center border-b border-blue-200">
            Your User ID: <span className="font-mono break-all">{userId}</span>
          </div>
        )}

        {/* Chat Messages Area */}
        <div className="flex-grow p-4 overflow-y-auto space-y-3">
          {messages.length === 0 && <p className="text-center text-gray-500">No messages yet. Start chatting!</p>}
          {messages.map((msg) => (
            <div
              key={msg.id}
              className={`flex ${msg.userId === userId ? 'justify-end' : 'justify-start'}`}
            >
              <div
                className={`max-w-[70%] p-3 rounded-lg shadow-md ${
                  msg.userId === userId
                    ? 'bg-blue-500 text-white rounded-br-none'
                    : 'bg-gray-200 text-gray-800 rounded-bl-none'
                }`}
              >
                <div className="font-semibold text-sm mb-1">
                  {msg.userName || 'Anonymous'}
                </div>
                <p className="text-base break-words">{msg.messageText}</p>
                {msg.timestamp && (
                  <div className="text-xs text-right mt-1 opacity-75">
                    {new Date(msg.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                  </div>
                )}
              </div>
            </div>
          ))}
          <div ref={messagesEndRef} /> {/* Empty div to scroll to */}
        </div>

        {/* Input Section */}
        <div className="p-4 border-t border-gray-200 bg-gray-50 flex flex-col gap-3">
          <input
            type="text"
            placeholder="Enter your name"
            value={userName}
            onChange={handleNameChange}
            className="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
            disabled={!userId} // Disable name input until auth is ready
          />
          <div className="flex gap-2">
            <textarea
              placeholder="Type your message..."
              value={messageText}
              onChange={handleMessageChange}
              onKeyPress={handleKeyPress}
              className="flex-grow p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none"
              rows="2"
              disabled={!userId || !userName.trim()} // Disable message input until auth and name are set
            ></textarea>
            <button
              onClick={handleSendMessage}
              className="px-6 py-3 bg-green-500 text-white rounded-md font-semibold hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 transition duration-200 ease-in-out shadow-md"
              disabled={!userId || !userName.trim() || messageText.trim() === ''} // Disable send button if no user, no name, or empty message
            >
              Send
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

export default App;
